'use client';

import React, { useCallback, useState } from 'react';

import s from './SubscribeToRecommendationsWidget.module.scss';
import clsx from 'clsx';
import { useMemberNotificationsSettings } from '@/services/members/hooks/useMemberNotificationsSettings';
import { IUserInfo } from '@/types/shared.types';
import { useParams } from 'next/navigation';
import { useUpdateMemberNotificationsSettings } from '@/services/members/hooks/useUpdateMemberNotificationsSettings';
import { useQueryClient } from '@tanstack/react-query';
import { MembersQueryKeys } from '@/services/members/constants';
import { FloatingWidgets } from '@/components/page/member-info/components/FloatingWidgets';
// import { useMember } from '@/services/members/hooks/useMember';
import { useMemberAnalytics } from '@/analytics/members.analytics';

interface Props {
  userInfo: IUserInfo;
}

export const SubscribeToRecommendationsWidget = ({ userInfo }: Props) => {
  const [view, setView] = useState<'initial' | 'confirmation'>('initial');
  const { data } = useMemberNotificationsSettings(userInfo?.uid);
  const { id } = useParams();
  // const { data: member } = useMember(userInfo.uid);
  const { mutateAsync, isPending } = useUpdateMemberNotificationsSettings();
  const queryClient = useQueryClient();
  const { onSubscribeToRecommendationsClicked, onCloseSubscribeToRecommendationsClicked } = useMemberAnalytics();

  const handleSubscribe = useCallback(async () => {
    if (!userInfo) {
      return;
    }

    const res = await mutateAsync({
      memberUid: userInfo.uid,
      subscribed: true,
    });

    if (res) {
      onSubscribeToRecommendationsClicked('widget');
      setView('confirmation');

      setTimeout(() => {
        queryClient.invalidateQueries({
          queryKey: [MembersQueryKeys.GET_NOTIFICATIONS_SETTINGS],
        });
      }, 5000);
    }
  }, [mutateAsync, onSubscribeToRecommendationsClicked, queryClient, userInfo]);

  const handleClose = useCallback(async () => {
    if (!userInfo) {
      return;
    }

    const res = await mutateAsync({
      memberUid: userInfo.uid,
      showInvitationDialog: false,
    });

    if (res) {
      onCloseSubscribeToRecommendationsClicked('widget');
      queryClient.invalidateQueries({
        queryKey: [MembersQueryKeys.GET_NOTIFICATIONS_SETTINGS],
      });
    }
  }, [mutateAsync, onCloseSubscribeToRecommendationsClicked, queryClient, userInfo]);

  // const isProfileFilled = member?.memberInfo.telegramHandler && member?.memberInfo.officeHours;

  if (!userInfo || userInfo.uid !== id || !data || data.subscribed || !data.recommendationsEnabled || !data.showInvitationDialog) {
    return null;
  }

  return (
    <FloatingWidgets>
      <div className={s.root}>
        {view === 'initial' && (
          <>
            <div
              className={clsx(s.top)}
              style={{
                backgroundImage: "url('/images/onboarding/Cubes.svg')",
              }}
            >
              <div className={s.mainTitle}>CONNECT WITH the RIGHT PEOPLE</div>
            </div>
            <div className={s.content}>
              <p className={s.desc}>Receive 2x/month email suggestions to meet high-signal peers in the Protocol Labs network.</p>
              <div className={s.controls}>
                <button className={s.primaryBtn} onClick={handleSubscribe} disabled={isPending}>
                  Opt-in for email
                  <GlowIcon />
                </button>
                <button className={s.secondaryBtn} onClick={handleClose} disabled={isPending}>
                  Not now
                </button>
              </div>
            </div>
          </>
        )}
        {view === 'confirmation' && (
          <div className={s.content}>
            <OptedIn />
            <p className={s.desc}>Make sure your profile is as complete as possible to increase the quality of matches.</p>
            <div className={s.controls}>
              <button className={s.primaryBtn} onClick={handleClose} disabled={isPending}>
                Complete my profile
                <GlowIcon />
              </button>
            </div>
          </div>
        )}
      </div>
    </FloatingWidgets>
  );
};

const GlowIcon = () => (
  <svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg" className={s.glow}>
    <path
      d="M11.688 11.0112L14.275 8.42418C14.6181 8.08112 14.8401 7.64508 14.8921 7.21197C14.9442 6.77886 14.822 6.38417 14.5526 6.11472C14.2831 5.84527 13.8884 5.72314 13.4553 5.77519C13.0222 5.82723 12.5862 6.0492 12.2431 6.39226L9.65611 8.97927C9.31305 9.32232 9.09109 9.75837 9.03904 10.1915C8.98699 10.6246 9.10912 11.0193 9.37857 11.2887C9.64802 11.5582 10.0427 11.6803 10.4758 11.6283C10.9089 11.5762 11.345 11.3542 11.688 11.0112Z"
      fill="#FF820E"
    />
    <path
      d="M3.08333 6.25795L3.23438 2.75042C3.2544 2.28529 3.11543 1.84602 2.84802 1.52925C2.5806 1.21248 2.20666 1.04416 1.80846 1.06131C1.41025 1.07845 1.0204 1.27967 0.724659 1.62069C0.428922 1.96171 0.251525 2.4146 0.231496 2.87973L0.0804535 6.38726C0.0604241 6.85239 0.199403 7.29166 0.466815 7.60843C0.734227 7.9252 1.10817 8.09352 1.50637 8.07637C1.90458 8.05923 2.29443 7.85801 2.59017 7.51699C2.88591 7.17597 3.0633 6.72308 3.08333 6.25795Z"
      fill="#FF820E"
      fillOpacity="0.7"
    />
    <path
      d="M17.9181 17.4427L14.4106 17.5938C13.9454 17.6138 13.4926 17.7912 13.1515 18.0869C12.8105 18.3827 12.6093 18.7725 12.5922 19.1707C12.575 19.5689 12.7433 19.9429 13.0601 20.2103C13.3769 20.4777 13.8161 20.6167 14.2813 20.5966L17.7888 20.4456C18.2539 20.4256 18.7068 20.2482 19.0478 19.9524C19.3889 19.6567 19.5901 19.2668 19.6072 18.8686C19.6244 18.4704 19.456 18.0965 19.1393 17.8291C18.8225 17.5617 18.3832 17.4227 17.9181 17.4427Z"
      fill="#FF820E"
      fillOpacity="0.7"
    />
  </svg>
);

const OptedIn = () => (
  <svg viewBox="0 0 328 124" fill="none" xmlns="http://www.w3.org/2000/svg">
    <g clipPath="url(#clip0_1947_56879)">
      <path
        d="M48.5823 42.7273H55.6278L60.1732 52.1818H60.3551L64.9005 42.7273H71.946L63.4005 58.6818V66H57.1278V58.6818L48.5823 42.7273ZM95.2461 54.3636C95.2461 56.9545 94.7423 59.1402 93.7347 60.9205C92.7271 62.6932 91.3673 64.0379 89.6552 64.9545C87.943 65.8636 86.034 66.3182 83.9279 66.3182C81.8067 66.3182 79.89 65.8598 78.1779 64.9432C76.4733 64.0189 75.1173 62.6705 74.1097 60.8977C73.1097 59.1174 72.6097 56.9394 72.6097 54.3636C72.6097 51.7727 73.1097 49.5909 74.1097 47.8182C75.1173 46.0379 76.4733 44.6932 78.1779 43.7841C79.89 42.8674 81.8067 42.4091 83.9279 42.4091C86.034 42.4091 87.943 42.8674 89.6552 43.7841C91.3673 44.6932 92.7271 46.0379 93.7347 47.8182C94.7423 49.5909 95.2461 51.7727 95.2461 54.3636ZM88.7461 54.3636C88.7461 52.9697 88.5605 51.7955 88.1893 50.8409C87.8256 49.8788 87.284 49.1515 86.5643 48.6591C85.8521 48.1591 84.9734 47.9091 83.9279 47.9091C82.8824 47.9091 81.9999 48.1591 81.2802 48.6591C80.568 49.1515 80.0264 49.8788 79.6552 50.8409C79.2915 51.7955 79.1097 52.9697 79.1097 54.3636C79.1097 55.7576 79.2915 56.9356 79.6552 57.8977C80.0264 58.8523 80.568 59.5795 81.2802 60.0795C81.9999 60.572 82.8824 60.8182 83.9279 60.8182C84.9734 60.8182 85.8521 60.572 86.5643 60.0795C87.284 59.5795 87.8256 58.8523 88.1893 57.8977C88.5605 56.9356 88.7461 55.7576 88.7461 54.3636ZM112.262 42.7273H118.58V57.6364C118.58 59.4091 118.156 60.9432 117.308 62.2386C116.467 63.5265 115.292 64.5227 113.785 65.2273C112.277 65.9242 110.527 66.2727 108.535 66.2727C106.527 66.2727 104.77 65.9242 103.262 65.2273C101.755 64.5227 100.58 63.5265 99.7394 62.2386C98.906 60.9432 98.4894 59.4091 98.4894 57.6364V42.7273H104.808V57.0909C104.808 57.8106 104.967 58.4545 105.285 59.0227C105.603 59.5833 106.042 60.0227 106.603 60.3409C107.171 60.6591 107.815 60.8182 108.535 60.8182C109.262 60.8182 109.906 60.6591 110.467 60.3409C111.027 60.0227 111.467 59.5833 111.785 59.0227C112.103 58.4545 112.262 57.8106 112.262 57.0909V42.7273ZM151.144 54.3636C151.144 56.9545 150.64 59.1402 149.632 60.9205C148.625 62.6932 147.265 64.0379 145.553 64.9545C143.841 65.8636 141.931 66.3182 139.825 66.3182C137.704 66.3182 135.788 65.8598 134.075 64.9432C132.371 64.0189 131.015 62.6705 130.007 60.8977C129.007 59.1174 128.507 56.9394 128.507 54.3636C128.507 51.7727 129.007 49.5909 130.007 47.8182C131.015 46.0379 132.371 44.6932 134.075 43.7841C135.788 42.8674 137.704 42.4091 139.825 42.4091C141.931 42.4091 143.841 42.8674 145.553 43.7841C147.265 44.6932 148.625 46.0379 149.632 47.8182C150.64 49.5909 151.144 51.7727 151.144 54.3636ZM144.644 54.3636C144.644 52.9697 144.458 51.7955 144.087 50.8409C143.723 49.8788 143.181 49.1515 142.462 48.6591C141.75 48.1591 140.871 47.9091 139.825 47.9091C138.78 47.9091 137.897 48.1591 137.178 48.6591C136.466 49.1515 135.924 49.8788 135.553 50.8409C135.189 51.7955 135.007 52.9697 135.007 54.3636C135.007 55.7576 135.189 56.9356 135.553 57.8977C135.924 58.8523 136.466 59.5795 137.178 60.0795C137.897 60.572 138.78 60.8182 139.825 60.8182C140.871 60.8182 141.75 60.572 142.462 60.0795C143.181 59.5795 143.723 58.8523 144.087 57.8977C144.458 56.9356 144.644 55.7576 144.644 54.3636ZM154.387 66V42.7273H164.432C166.16 42.7273 167.671 43.0682 168.966 43.75C170.262 44.4318 171.269 45.3902 171.989 46.625C172.709 47.8598 173.069 49.303 173.069 50.9545C173.069 52.6212 172.697 54.0644 171.955 55.2841C171.22 56.5038 170.186 57.4432 168.853 58.1023C167.527 58.7614 165.978 59.0909 164.205 59.0909H158.205V54.1818H162.932C163.675 54.1818 164.307 54.053 164.83 53.7955C165.36 53.5303 165.766 53.1553 166.046 52.6705C166.334 52.1856 166.478 51.6136 166.478 50.9545C166.478 50.2879 166.334 49.7197 166.046 49.25C165.766 48.7727 165.36 48.4091 164.83 48.1591C164.307 47.9015 163.675 47.7727 162.932 47.7727H160.705V66H154.387ZM175.071 47.8182V42.7273H195.298V47.8182H188.298V66H182.071V47.8182H175.071ZM197.996 66V42.7273H214.768V47.8182H204.314V51.8182H213.905V56.9091H204.314V60.9091H214.723V66H197.996ZM227.176 66H218.222V42.7273H227.085C229.479 42.7273 231.548 43.1932 233.29 44.125C235.04 45.0492 236.389 46.3826 237.336 48.125C238.29 49.8598 238.767 51.9394 238.767 54.3636C238.767 56.7879 238.294 58.8712 237.347 60.6136C236.4 62.3485 235.059 63.6818 233.324 64.6136C231.589 65.5379 229.54 66 227.176 66ZM224.54 60.6364H226.949C228.101 60.6364 229.082 60.4508 229.892 60.0795C230.71 59.7083 231.332 59.0682 231.756 58.1591C232.188 57.25 232.404 55.9848 232.404 54.3636C232.404 52.7424 232.184 51.4773 231.745 50.5682C231.313 49.6591 230.676 49.0189 229.835 48.6477C229.002 48.2765 227.979 48.0909 226.767 48.0909H224.54V60.6364ZM255.024 42.7273V66H248.706V42.7273H255.024ZM278.474 42.7273V66H273.202L264.793 53.7727H264.656V66H258.338V42.7273H263.702L271.974 54.9091H272.156V42.7273H278.474Z"
        fill="#156FF7"
      />
      <path
        d="M49.3161 79.4105L49.8434 79.0968C49.94 79.0393 49.9252 78.8846 49.8207 78.8495L49.2468 78.6572L49.1351 78.013C49.1148 77.8954 48.9746 77.8627 48.9122 77.9606L48.5673 78.4964L47.9721 78.4139C47.8642 78.3986 47.7919 78.5339 47.8574 78.6286L48.216 79.1515L47.9589 79.7429C47.9115 79.8504 48.0068 79.9671 48.1107 79.9283L48.6798 79.7161L49.1166 80.1651C49.1962 80.2469 49.3269 80.1845 49.3251 80.0646L49.3161 79.4105Z"
        fill="#156FF7"
        fillOpacity="0.2"
      />
      <path
        d="M42.0812 85.0031L43.4833 86.0812C43.74 86.2787 44.0852 86.0424 44.036 85.7061L43.7653 83.8607L45.1396 82.737C45.3905 82.5321 45.2908 82.0992 44.982 82.0484L43.2877 81.7596L42.7317 79.9927C42.6319 79.6719 42.2225 79.6405 42.0823 79.9428L41.3046 81.6033L39.5899 81.63C39.2776 81.633 39.1231 82.0464 39.3451 82.2877L40.5612 83.6105L40.0555 85.3963C39.9635 85.7217 40.2748 86.0085 40.5544 85.8521L42.0812 85.0031Z"
        fill="#156FF7"
        fillOpacity="0.6"
      />
      <path
        d="M35.5102 76.8321L37.3833 76.1388C37.7265 76.0119 37.7585 75.5009 37.4376 75.3228L35.6756 74.346L35.6469 72.1873C35.6419 71.7934 35.204 71.601 34.9511 71.8803L33.5548 73.406L31.6665 72.7723C31.3245 72.6561 31.0198 73.0507 31.1834 73.3982L32.0758 75.3149L30.9354 77.0753C30.7262 77.3947 30.9749 77.832 31.3319 77.7701L33.2881 77.4319L34.4723 79.1572C34.6882 79.4714 35.1446 79.3496 35.2006 78.9594L35.5102 76.8321Z"
        fill="#156FF7"
      />
      <path
        d="M33.4823 89.4261L35.6313 88.6307C36.0249 88.4852 36.0616 87.8989 35.6935 87.6946L33.6721 86.5739L33.6392 84.0973C33.6334 83.6454 33.1311 83.4247 32.8409 83.7451L31.2389 85.4955L29.0726 84.7685C28.6802 84.6352 28.3307 85.0879 28.5183 85.4866L29.5422 87.6855L28.2339 89.7052C27.9938 90.0716 28.2792 90.5733 28.6887 90.5023L30.933 90.1143L32.2916 92.0935C32.5392 92.454 33.0629 92.3144 33.1271 91.8667L33.4823 89.4261Z"
        fill="#156FF7"
      />
      <path
        d="M237.877 67.1136L239.452 68.6886C239.661 68.8974 239.927 69.0325 240.19 69.0642C240.454 69.0959 240.694 69.0216 240.858 68.8575C241.022 68.6935 241.097 68.4532 241.065 68.1895C241.033 67.9259 240.898 67.6604 240.689 67.4516L239.114 65.8766C238.905 65.6678 238.64 65.5327 238.376 65.501C238.113 65.4693 237.872 65.5436 237.708 65.7077C237.544 65.8717 237.47 66.112 237.502 66.3757C237.533 66.6393 237.668 66.9048 237.877 67.1136Z"
        fill="#156FF7"
      />
      <path
        d="M240.771 61.8741L242.906 61.9661C243.189 61.9782 243.457 61.8936 243.65 61.7308C243.842 61.568 243.945 61.3404 243.934 61.098C243.924 60.8556 243.801 60.6182 243.594 60.4382C243.386 60.2581 243.111 60.1501 242.827 60.1379L240.692 60.046C240.409 60.0338 240.141 60.1184 239.949 60.2812C239.756 60.444 239.653 60.6717 239.664 60.9141C239.674 61.1565 239.797 61.3938 240.004 61.5739C240.212 61.7539 240.488 61.8619 240.771 61.8741Z"
        fill="#156FF7"
        fillOpacity="0.7"
      />
      <path
        d="M233.966 70.9069L233.874 68.7716C233.862 68.4885 233.754 68.2127 233.574 68.0051C233.394 67.7975 233.156 67.675 232.914 67.6646C232.671 67.6541 232.444 67.7566 232.281 67.9495C232.118 68.1423 232.033 68.4097 232.046 68.6929L232.138 70.8282C232.15 71.1114 232.258 71.3871 232.438 71.5947C232.618 71.8023 232.855 71.9248 233.098 71.9352C233.34 71.9457 233.568 71.8432 233.731 71.6504C233.893 71.4575 233.978 71.1901 233.966 70.9069Z"
        fill="#156FF7"
        fillOpacity="0.7"
      />
      <path
        d="M296.809 32.5518C296.964 32.5021 297.102 32.4011 297.202 32.2629C297.302 32.1246 297.36 31.9559 297.369 31.7799C297.376 31.6 297.333 31.4221 297.245 31.2691L296.648 30.2853C296.499 30.0371 296.405 29.7546 296.374 29.4601C296.343 29.1656 296.375 28.8672 296.468 28.5886L296.853 27.4699C296.905 27.3005 296.907 27.1175 296.859 26.9467C296.81 26.7759 296.714 26.626 296.583 26.5179C296.453 26.4099 296.294 26.3493 296.13 26.3446C295.967 26.3399 295.805 26.3914 295.67 26.4918L294.766 27.1439C294.538 27.3063 294.279 27.4086 294.009 27.4427C293.738 27.4768 293.464 27.4417 293.209 27.3403L292.183 26.9241C292.029 26.8667 291.863 26.8631 291.707 26.9137C291.551 26.9644 291.413 27.0667 291.313 27.2065C291.213 27.3463 291.155 27.5167 291.148 27.6939C291.141 27.8711 291.185 28.0463 291.273 28.1951L291.882 29.199C292.025 29.4425 292.116 29.7183 292.147 30.0056C292.178 30.2928 292.149 30.5841 292.062 30.8573L291.676 31.9738C291.624 32.1416 291.62 32.3231 291.667 32.4931C291.713 32.663 291.807 32.813 291.935 32.9222C292.064 33.0313 292.22 33.0943 292.382 33.1023C292.545 33.1102 292.706 33.0629 292.842 32.9667L293.744 32.3138C293.973 32.1509 294.234 32.0487 294.505 32.0155C294.777 31.9822 295.052 32.0189 295.308 32.1224L296.335 32.5401C296.489 32.5977 296.654 32.6014 296.809 32.5518Z"
        fill="#156FF7"
      />
      <path
        opacity="0.9"
        d="M311.954 24.6683C312.005 24.6185 312.041 24.5525 312.057 24.4795C312.072 24.4065 312.066 24.33 312.04 24.2607C312.013 24.1902 311.967 24.1303 311.908 24.0888L311.514 23.829C311.415 23.7631 311.332 23.673 311.271 23.566C311.21 23.4589 311.173 23.3379 311.162 23.2123L311.123 22.7061C311.115 22.6307 311.085 22.5599 311.038 22.5038C310.991 22.4477 310.929 22.4092 310.861 22.3935C310.793 22.3779 310.722 22.3859 310.658 22.4166C310.594 22.4473 310.541 22.499 310.505 22.5645L310.267 22.9943C310.206 23.1018 310.124 23.1925 310.025 23.2591C309.927 23.3258 309.816 23.3665 309.701 23.3782L309.237 23.4214C309.168 23.4298 309.104 23.4614 309.052 23.5118C309.001 23.5621 308.965 23.6287 308.95 23.7023C308.935 23.7759 308.941 23.8528 308.968 23.9223C308.994 23.9919 309.04 24.0505 309.099 24.0902L309.501 24.3556C309.596 24.4208 309.677 24.5088 309.737 24.6131C309.797 24.7174 309.834 24.8351 309.846 24.9574L309.884 25.463C309.892 25.538 309.921 25.6084 309.967 25.6645C310.013 25.7206 310.075 25.7597 310.142 25.7763C310.21 25.7928 310.28 25.7861 310.344 25.7569C310.408 25.7278 310.462 25.6778 310.498 25.6137L310.736 25.184C310.797 25.0761 310.88 24.9852 310.979 24.9186C311.078 24.852 311.189 24.8116 311.305 24.8006L311.77 24.7577C311.838 24.7495 311.903 24.718 311.954 24.6683Z"
        fill="#156FF7"
      />
    </g>
    <defs>
      <clipPath id="clip0_1947_56879">
        <rect width="328" height="124" fill="white" />
      </clipPath>
    </defs>
  </svg>
);
